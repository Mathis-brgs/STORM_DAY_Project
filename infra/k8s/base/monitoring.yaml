# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# PROMETHEUS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: storm
data:
  prometheus.yml: |
    global:
      scrape_interval:     15s
      evaluation_interval: 15s

    alerting:
      alertmanagers:
        - static_configs:
            - targets: ['alertmanager:9093']

    rule_files:
      - /etc/prometheus/alerts.yml

    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets: ['localhost:9090']

      - job_name: nats
        static_configs:
          - targets: ['nats:8222']
        metrics_path: /metrics

      - job_name: gateway
        static_configs:
          - targets: ['gateway-service:8080']
        metrics_path: /metrics

      - job_name: media
        static_configs:
          - targets: ['media-service:8080']
        metrics_path: /metrics

      - job_name: notification
        static_configs:
          - targets: ['notification-service:8080']
        metrics_path: /metrics

      - job_name: message
        static_configs:
          - targets: ['message-service:8080']
        metrics_path: /metrics

      - job_name: user
        static_configs:
          - targets: ['user-service:3000']
        metrics_path: /metrics

      - job_name: minio
        metrics_path: /minio/prometheus/metrics
        static_configs:
          - targets: ['minio:9000']

  alerts.yml: |
    groups:
      - name: storm.services
        rules:
          - alert: ServiceDown
            expr: up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.job }} est DOWN"
              description: "{{ $labels.job }} injoignable depuis > 1 min."

          - alert: HighLatency
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Latence p95 > 500ms sur {{ $labels.job }}"

          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.01
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Taux d'erreurs 5xx > 1% sur {{ $labels.job }}"

      - name: storm.pods
        rules:
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 > 3
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod {{ $labels.pod }} crash en boucle"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: storm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus:v2.55.1
          args:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=7d"
            - "--web.enable-lifecycle"
          ports:
            - containerPort: 9090
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus
            - name: data
              mountPath: /prometheus
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9090
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: prometheus-config
        - name: data
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: storm
spec:
  type: NodePort
  selector:
    app: prometheus
  ports:
    - port: 9090
      targetPort: 9090
      nodePort: 30090

---
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# GRAFANA
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: storm
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus:9090
        access: proxy
        isDefault: true
        editable: false

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: storm
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: storm-dashboards
        folder: STORM
        type: file
        options:
          path: /var/lib/grafana/dashboards

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-overview
  namespace: storm
data:
  storm-overview.json: |
    {
      "title": "STORM ‚Äî Vue d'ensemble",
      "uid": "storm-overview",
      "schemaVersion": 38,
      "refresh": "10s",
      "panels": [
        {
          "id": 1, "type": "stat", "title": "Services UP",
          "gridPos": {"x":0,"y":0,"w":4,"h":4},
          "targets": [{"expr":"count(up == 1)","legendFormat":"Up"}],
          "options": {"colorMode":"background","graphMode":"none"}
        },
        {
          "id": 2, "type": "stat", "title": "Services DOWN",
          "gridPos": {"x":4,"y":0,"w":4,"h":4},
          "targets": [{"expr":"count(up == 0) or vector(0)","legendFormat":"Down"}],
          "options": {"colorMode":"background","graphMode":"none","thresholds":{"steps":[{"color":"green","value":0},{"color":"red","value":1}]}}
        },
        {
          "id": 3, "type": "timeseries", "title": "HTTP Requests / sec",
          "gridPos": {"x":0,"y":4,"w":12,"h":8},
          "targets": [{"expr":"sum(rate(http_requests_total[1m])) by (job)","legendFormat":"{{job}}"}]
        },
        {
          "id": 4, "type": "timeseries", "title": "Latence p95 (ms)",
          "gridPos": {"x":12,"y":4,"w":12,"h":8},
          "targets": [{"expr":"histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) * 1000","legendFormat":"{{job}} p95"}]
        },
        {
          "id": 5, "type": "timeseries", "title": "Taux d'erreurs 5xx",
          "gridPos": {"x":0,"y":12,"w":12,"h":8},
          "targets": [{"expr":"sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (job)","legendFormat":"{{job}}"}]
        },
        {
          "id": 6, "type": "timeseries", "title": "M√©moire pods (Mi)",
          "gridPos": {"x":12,"y":12,"w":12,"h":8},
          "targets": [{"expr":"sum(container_memory_usage_bytes{namespace=\"storm\"}) by (pod) / 1024 / 1024","legendFormat":"{{pod}}"}]
        }
      ]
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting
  namespace: storm
data:
  alerting.yml: |
    apiVersion: 1
    contactPoints:
      - orgId: 1
        name: Slack Critical
        receivers:
          - uid: slack-critical
            type: slack
            disableResolveMessage: false
            settings:
              url: ${SLACK_WEBHOOK_URL}
              title: |
                [{{ .Status | toUpper }}{{ if eq .Status "firing" }} üî•{{ else }} ‚úÖ{{ end }}] STORM ‚Äî {{ .CommonLabels.alertname }}
              text: |
                {{ range .Alerts }}
                *{{ .Annotations.summary }}*
                {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
                Severity: `{{ .Labels.severity }}`
                {{ end }}
              username: STORM Alerts
              icon_emoji: ":warning:"
      - orgId: 1
        name: Discord Alerts
        receivers:
          - uid: discord-alerts
            type: discord
            disableResolveMessage: false
            settings:
              url: ${DISCORD_WEBHOOK_URL}
              message: |
                **[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}**
                {{ range .Alerts -}}
                > {{ .Annotations.summary }}
                {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
                S√©v√©rit√© : **{{ .Labels.severity }}**
                {{ end }}
    ---
    apiVersion: 1
    policies:
      - orgId: 1
        receiver: Discord Alerts
        group_by: ['alertname', 'severity']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 4h
        routes:
          - receiver: Slack Critical
            matchers:
              - severity = critical
            continue: true
          - receiver: Discord Alerts
            matchers:
              - severity = warning

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: storm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:11.4.0
          ports:
            - containerPort: 3001
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: "admin"
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: "storm2024"
            - name: GF_SERVER_HTTP_PORT
              value: "3001"
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: grafana-alerting-secrets
                  key: SLACK_WEBHOOK_URL
            - name: DISCORD_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: grafana-alerting-secrets
                  key: DISCORD_WEBHOOK_URL
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboards-provider
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboards-data
              mountPath: /var/lib/grafana/dashboards
            - name: alerting
              mountPath: /etc/grafana/provisioning/alerting
            - name: storage
              mountPath: /var/lib/grafana
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
              ephemeral-storage: "256Mi"
            limits:
              memory: "256Mi"
              cpu: "200m"
              ephemeral-storage: "512Mi"
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3001
            initialDelaySeconds: 15
            periodSeconds: 10
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboards-provider
          configMap:
            name: grafana-dashboards-provider
        - name: dashboards-data
          projected:
            sources:
              - configMap:
                  name: grafana-dashboard-overview
              - configMap:
                  name: grafana-dashboards-services
        - name: alerting
          configMap:
            name: grafana-alerting
        - name: storage
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: storm
spec:
  type: NodePort
  selector:
    app: grafana
  ports:
    - port: 3001
      targetPort: 3001
      nodePort: 30030