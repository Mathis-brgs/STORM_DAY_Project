apiVersion: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Contact Points â€” oÃ¹ envoyer les alertes
# Les URLs sont injectÃ©es via variables d'environnement :
#   SLACK_WEBHOOK_URL   â†’ webhook Slack (Incoming Webhooks app)
#   DISCORD_WEBHOOK_URL â†’ webhook Discord (channel settings > Integrations)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

contactPoints:

  # Slack â€” alertes critiques (ServiceDown, PodCrashLooping)
  - orgId: 1
    name: Slack Critical
    receivers:
      - uid: slack-critical
        type: slack
        disableResolveMessage: false
        settings:
          url: ${SLACK_WEBHOOK_URL}
          title: |
            [{{ .Status | toUpper }}{{ if eq .Status "firing" }} ðŸ”¥{{ else }} âœ…{{ end }}] STORM â€” {{ .CommonLabels.alertname }}
          text: |
            {{ range .Alerts }}
            *{{ .Annotations.summary }}*
            {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
            Severity: `{{ .Labels.severity }}`
            {{ end }}
          username: STORM Alerts
          icon_emoji: ":warning:"

  # Discord â€” toutes les alertes (warning + critical)
  - orgId: 1
    name: Discord Alerts
    receivers:
      - uid: discord-alerts
        type: discord
        disableResolveMessage: false
        settings:
          url: ${DISCORD_WEBHOOK_URL}
          message: |
            **[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}**
            {{ range .Alerts -}}
            > {{ .Annotations.summary }}
            {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
            SÃ©vÃ©ritÃ© : **{{ .Labels.severity }}**
            {{ end }}

---
apiVersion: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Notification Policies â€” qui reÃ§oit quoi
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

policies:
  - orgId: 1
    receiver: Discord Alerts        # rÃ©cepteur par dÃ©faut (toutes les alertes)
    group_by: ['alertname', 'severity']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
    routes:
      # Alertes critiques â†’ Slack ET Discord
      - receiver: Slack Critical
        matchers:
          - severity = critical
        continue: true              # continue = aussi envoyÃ© Ã  Discord via default

      # Warnings â†’ Discord uniquement (pas de Slack pour ne pas spammer)
      - receiver: Discord Alerts
        matchers:
          - severity = warning
